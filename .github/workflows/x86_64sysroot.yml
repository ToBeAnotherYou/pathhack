name: Build x86_64 sysroot for SSLVPNClient

on:
  push:
  workflow_dispatch:

jobs:
  build-sysroot:
    runs-on: ubuntu-22.04

    steps:
      # 1️⃣ Checkout 仓库
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ 安装必要工具
      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            debootstrap \
            qemu-user-static \
            binutils \
            tar \
            gzip

      # 3️⃣ 创建 x86_64 sysroot
      - name: Build x86_64 sysroot
        run: |
          SYSROOT_DIR="$PWD/sysroot"
          sudo rm -rf "$SYSROOT_DIR"
          mkdir -p "$SYSROOT_DIR"

          # 使用 root 构建 x86_64 Ubuntu 20.04
          sudo debootstrap --arch=amd64 focal "$SYSROOT_DIR" http://archive.ubuntu.com/ubuntu

          # 修复权限，让 runner 用户可以访问
          sudo chown -R $USER:$USER "$SYSROOT_DIR"
          sudo chmod -R u+rwX "$SYSROOT_DIR"

          # 可选：只上传必要目录，避免上传 /lib/ssl/private 等敏感目录
          mkdir -p "$PWD/sysroot_upload"
          cp -a "$SYSROOT_DIR"/bin "$SYSROOT_DIR"/lib "$SYSROOT_DIR"/usr "$SYSROOT_DIR"/opt "$PWD/sysroot_upload"

          echo "Sysroot prepared and permissions fixed"
          ls -l "$PWD/sysroot_upload"

      # 4️⃣ 上传 artifact
      - name: Upload x86_64 sysroot
        uses: actions/upload-artifact@v4
        with:
          name: x86_64-sysroot
          path: sysroot_upload
