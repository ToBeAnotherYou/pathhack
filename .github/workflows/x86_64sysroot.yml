name: Build x86_64 sysroot

on:
  push:
  workflow_dispatch:

jobs:
  build-x86-sysroot:
    runs-on: ubuntu-22.04  # AMD64 runner

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: Pull Ubuntu 20.04 x86_64 image
        run: |
          docker pull ubuntu:20.04

      - name: Export Ubuntu sysroot
        run: |
          # 创建临时容器
          docker create --name temp ubuntu:20.04
          # 导出容器为 tar
          docker export temp > ubuntu20.04-x86_64.tar
          # 删除临时容器
          docker rm temp
          # 解压到 sysroot 目录
          mkdir -p sysroot
          tar -xf ubuntu20.04-x86_64.tar -C sysroot

          # 调整权限，避免上传失败
          sudo chmod -R a+r sysroot
          sudo find sysroot -type d -exec chmod a+rx {} \;

      - name: Upload sysroot artifact
        uses: actions/upload-artifact@v4
        with:
          name: x86_64-sysroot
          path: sysroot
