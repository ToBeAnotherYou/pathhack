name: Build pathhack.so

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]  # 两个架构都构建

    container:
      image: ubuntu:20.04

    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc-multilib gcc-aarch64-linux-gnu

      - name: Set compiler based on architecture
        run: |
          if [ "${{ matrix.arch }}" == "aarch64" ]; then
            export CC=aarch64-linux-gnu-gcc
          else
            export CC=gcc
          fi
          echo "Using compiler $CC"
        shell: bash

      - name: Compile pathhack.so
        run: |
          if [ "${{ matrix.arch }}" == "aarch64" ]; then
            aarch64-linux-gnu-gcc -shared -fPIC -O2 \
              -o pathhack-aarch64.so pathhack.c -ldl
          else
            gcc -shared -fPIC -O2 -O2 \
              -o pathhack-x86_64.so pathhack.c -ldl
          fi
          file pathhack-*.so

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pathhack-${{ matrix.arch }}
          path: pathhack-*.so
